name: Wiki Service - Tests

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

jobs:
  tests:
    name: Run Wiki Service test suite
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: services/wiki

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: Le555ecure
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'services/wiki/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (root)
        working-directory: .
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Wiki service extra dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Install pre-commit
        run: |
          pip install pre-commit

      - name: Run pre-commit checks
        run: |
          pre-commit run --all-files

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create test database
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: Le555ecure
        run: |
          # Wait for PostgreSQL to be ready
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          # Create test database (if it doesn't exist)
          psql -h localhost -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'arcadium_testing_wiki'" | grep -q 1 || \
          psql -h localhost -U postgres -c "CREATE DATABASE arcadium_testing_wiki"

      - name: Install pytest reporting tools
        run: |
          pip install pytest-html pytest-json-report

      - name: Run pytest for Wiki Service
        env:
          FLASK_ENV: testing
          TEST_DATABASE_URL: postgresql://postgres:Le555ecure@localhost:5432/arcadium_testing_wiki
        continue-on-error: true
        run: |
          # Run tests with better output formatting
          pytest \
            --tb=short \
            --maxfail=10 \
            --junit-xml=test-results.xml \
            --html=test-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=test-report.json \
            -v \
            --durations=10

      - name: Generate failure summary
        if: always()
        run: |
          echo "=== TEST EXECUTION SUMMARY ===" > test-summary.txt
          echo "" >> test-summary.txt

          # Extract summary from JSON report
          if [ -f test-report.json ]; then
            python3 << 'PYTHON_SCRIPT'
          import json
          import sys

          try:
              with open('test-report.json', 'r') as f:
                  report = json.load(f)

              summary = report.get('summary', {})
              total = summary.get('total', 0)
              passed = summary.get('passed', 0)
              failed = summary.get('failed', 0)
              skipped = summary.get('skipped', 0)

              print(f"Total tests: {total}")
              print(f"Passed: {passed}")
              print(f"Failed: {failed}")
              print(f"Skipped: {skipped}")
              print("")

              if failed > 0:
                  print("=== FAILED TESTS ===")
                  for test in report.get('tests', []):
                      if test.get('outcome') == 'failed':
                          nodeid = test.get('nodeid', 'unknown')
                          call = test.get('call', {})
                          longrepr = call.get('longrepr', 'No error details')

                          print(f"\n{nodeid}")
                          print("-" * 80)
                          # Show first 30 lines of error
                          lines = longrepr.split('\n')[:30]
                          print('\n'.join(lines))
                          if len(longrepr.split('\n')) > 30:
                              print(f"... (truncated, {len(longrepr.split('\n')) - 30} more lines)")
                          print("")
          except Exception as e:
              print(f"Error generating summary: {e}", file=sys.stderr)
          PYTHON_SCRIPT
          fi >> test-summary.txt

      - name: Display test summary
        if: always()
        run: |
          echo "=== TEST EXECUTION SUMMARY ==="
          if [ -f test-summary.txt ]; then
            cat test-summary.txt
          else
            echo "Summary file not found"
          fi

          # Show pass/fail status
          if [ -f test-report.json ]; then
            python3 << 'PYTHON_SCRIPT'
          import json
          import sys

          try:
              with open('test-report.json', 'r') as f:
                  report = json.load(f)
              failed = report.get('summary', {}).get('failed', 0)
              if failed > 0:
                  print(f"\n❌ {failed} test(s) failed")
                  sys.exit(1)
              else:
                  print("\n✅ All tests passed")
          except Exception as e:
              print(f"Error reading report: {e}", file=sys.stderr)
          PYTHON_SCRIPT
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wiki-test-results
          path: |
            services/wiki/test-results.xml
            services/wiki/test-report.html
            services/wiki/test-report.json
            services/wiki/test-summary.txt
          retention-days: 7

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: services/wiki/test-results.xml
          check_name: Wiki Service Test Results
          comment_mode: create new
          report_individual_runs: true
