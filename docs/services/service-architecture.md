# Service Architecture Overview

## Service Communication Patterns

### Service-to-Service Authentication

**Service Tokens:**
- Long-lived JWT tokens (90 days)
- Generated by Auth Service during setup
- Stored in environment variables
- Format: `Authorization: Service-Token <token>`
- Contains: `service_id`, `service_name`, `type: "service"`

**Token Management:**
- Created during initial service setup
- Rotated manually (future: automatic rotation)
- One token per service (not per instance)
- Validated by Auth Service or shared library

### Service Discovery

**Current Implementation:**
- Environment variables for service URLs
- Docker Compose service names for local development
- Configuration files per service

**Service URLs:**
```bash
# Local Development
AUTH_SERVICE_URL=http://localhost:8000
NOTIFICATION_SERVICE_URL=http://localhost:8006
WIKI_SERVICE_URL=http://localhost:5000

# Docker Compose
AUTH_SERVICE_URL=http://auth:8000
NOTIFICATION_SERVICE_URL=http://notification:8006
WIKI_SERVICE_URL=http://wiki:5000
```

### Health Checks

**Endpoint:** `GET /health`

**All services implement:**
```json
{
  "status": "healthy" | "degraded" | "unhealthy",
  "service": "service-name",
  "version": "1.0.0",
  "database": "connected" | "disconnected",
  "dependencies": {
    "auth": "healthy",
    "notification": "healthy"
  },
  "timestamp": "2024-01-01T00:00:00Z"
}
```

**Usage:**
- Docker Compose health checks
- Service status monitoring
- Load balancer health checks (future)

### Error Handling

**Retry Logic:**
- 3 attempts for failed requests
- Exponential backoff: 1s, 2s, 4s
- Timeout: 5 seconds per request

**Non-Blocking Operations:**
- Notification sending (logs error, continues)
- Non-critical service calls
- Graceful degradation

**Error Logging:**
- All service call failures logged
- Include: endpoint, error, retry count, timestamp
- Context for debugging

## Database Architecture

### Schema Organization

**Separate Schemas:**
```sql
-- Auth Service
CREATE SCHEMA auth;
-- Tables: users, token_blacklist, password_history

-- Wiki Service
CREATE SCHEMA wiki;
-- Tables: pages, comments, page_links, index_entries, etc.

-- Notification Service
CREATE SCHEMA notification;
-- Tables: notifications, admin_notification_reads
```

**Benefits:**
- Clear separation of concerns
- Schema-level permissions
- Independent migrations
- Easier backup/restore per service

### Connection Management

**Connection Pooling:**
- 10 connections per service (default)
- Configurable via environment variable
- Connection timeout: 5 seconds
- Max idle time: 30 minutes

**Connection String:**
```
DATABASE_URL=postgresql://user:password@host:5432/arcadium
```

**Migration Strategy:**
- Each service manages own migrations
- Migrations in `infrastructure/database/migrations/`
- Run on service startup
- Version tracking per schema

## Service Status Monitoring

### Health Check Dashboard (Future)

Display service statuses:
- Service name
- Health status (healthy/degraded/unhealthy)
- Last check time
- Response time
- Database connection status
- Dependency status

### Monitoring Endpoints

**Service Status:**
```
GET /api/status
```

**Response:**
```json
{
  "service": "wiki",
  "status": "healthy",
  "uptime": 3600,
  "version": "1.0.0",
  "database": "connected",
  "dependencies": {
    "auth": {
      "status": "healthy",
      "response_time_ms": 15
    },
    "notification": {
      "status": "healthy",
      "response_time_ms": 12
    }
  }
}
```

## Security Considerations

### Service Token Security
- Tokens stored in environment variables (never in code)
- Rotated periodically
- Revoked if compromised
- Separate from user JWT tokens

### Network Security
- Services communicate over internal network (Docker)
- HTTPS in production (future)
- Service-to-service authentication required
- Rate limiting on public endpoints

### Database Security
- Schema-level permissions
- Service-specific database users (future)
- Encrypted connections (future)
- Regular backups

## Deployment Considerations

### Docker Compose
- Services defined in `docker-compose.yml`
- Health checks configured
- Service names for discovery
- Volume mounts for development

### Environment Configuration
- Environment variables for all config
- Separate `.env` files per environment
- Secrets management (future: Vault, etc.)

### Scaling (Future)
- Horizontal scaling per service
- Load balancing
- Service mesh for advanced routing
- Auto-scaling based on metrics

